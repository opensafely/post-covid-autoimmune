version: '3.0'

expectations:

  population_size: 150000

actions:

  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 
  ## DO NOT EDIT project.yaml DIRECTLY 
  ## This file is created by create_project_actions.R 
  ## Edit and run create_project_actions.R to update the project.yaml 
  ## # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # 

  vax_eligibility_inputs:
    run: r:latest analysis/metadates.R
    outputs:
      highly_sensitive:
        study_dates_json: output/study_dates.json
        vax_jcvi_groups: output/vax_jcvi_groups.csv.gz
        vax_eligible_dates: output/vax_eligible_dates.csv.gz

  generate_study_population_prelim:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_prelim
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    outputs:
      highly_sensitive:
        cohort: output/input_prelim.csv.gz

  generate_index_dates:
    run: r:latest analysis/prelim.R
    needs:
    - vax_eligibility_inputs
    - generate_study_population_prelim
    outputs:
      highly_sensitive:
        index_dates: output/index_dates.csv.gz

  ## Generate study population - prevax 

  generate_study_population_prevax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_prevax
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_prevax.csv.gz

  ## Generate study population - unvax 

  generate_study_population_unvax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_unvax
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_unvax.csv.gz

  ## Generate study population - vax 

  generate_study_population_vax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_vax
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_vax.csv.gz

  ## Generate study population history - prevax 

  generate_study_population_history_prevax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_prevax_history
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_prevax_history.csv.gz

  ## Generate study population history - unvax 

  generate_study_population_history_unvax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_unvax_history
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_unvax_history.csv.gz

  ## Generate study population history - vax 

  generate_study_population_history_vax:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_vax_history
      --output-format csv.gz
    needs:
    - vax_eligibility_inputs
    - generate_index_dates
    outputs:
      highly_sensitive:
        cohort: output/input_vax_history.csv.gz

  ## Join study definitions - prevax 

  join_study_definitions_prevax:
    run: r:latest analysis/preprocess/join_study_definitions.R prevax
    needs:
    - generate_study_population_prevax
    - generate_study_population_history_prevax
    outputs:
      highly_sensitive:
        cohort_final: output/input_prevax_final.rds

  ## Join study definitions - unvax 

  join_study_definitions_unvax:
    run: r:latest analysis/preprocess/join_study_definitions.R unvax
    needs:
    - generate_study_population_unvax
    - generate_study_population_history_unvax
    outputs:
      highly_sensitive:
        cohort_final: output/input_unvax_final.rds

  ## Join study definitions - vax 

  join_study_definitions_vax:
    run: r:latest analysis/preprocess/join_study_definitions.R vax
    needs:
    - generate_study_population_vax
    - generate_study_population_history_vax
    outputs:
      highly_sensitive:
        cohort_final: output/input_vax_final.rds

